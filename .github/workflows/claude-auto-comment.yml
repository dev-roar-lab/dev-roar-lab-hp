name: Claude Auto Comment

on:
  schedule:
    # 23æ™‚ã‹ã‚‰ç¿Œæœ9æ™‚ã¾ã§ã€1æ™‚é–“ã«1å›å®Ÿè¡Œ (UTCæ™‚åˆ»ã§æŒ‡å®š: JST-9h)
    # 23æ™‚ (JST) = 14æ™‚ (UTC)
    # 0æ™‚-8æ™‚ (JST) = 15æ™‚-23æ™‚ (UTCå‰æ—¥), 0æ™‚-8æ™‚ (UTC)
    - cron: '0 14-23 * * *' # 23æ™‚-ç¿Œ8æ™‚ (JST)
    - cron: '0 0-9 * * *' # 9æ™‚-18æ™‚ (JST) â€»ã“ã®ã†ã¡0æ™‚ã®ã¿ãŒè©²å½“
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: read
  issues: write

jobs:
  auto-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Get highest priority open issue
        id: get_issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # å„ªå…ˆåº¦é † (high â†’ medium â†’ low) ã§openãªissueã‚’å–å¾—
          # claude-code-requestedãƒ©ãƒ™ãƒ«ãŒãªã„ã‚‚ã®ã‚’å„ªå…ˆ

          # ã¾ãšã€claude-code-requestedãƒ©ãƒ™ãƒ«ãŒãªã„ high priority issue ã‚’æ¢ã™
          ISSUE_NUMBER=$(gh issue list \
            --repo ${{ github.repository }} \
            --label priority:high \
            --state open \
            --json number,title,labels \
            --jq '[.[] | select(.labels | map(.name) | contains(["claude-code-requested"]) | not)] | first | .number // empty')

          # ãªã‘ã‚Œã° medium priority ã‚’æ¢ã™
          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(gh issue list \
              --repo ${{ github.repository }} \
              --label priority:medium \
              --state open \
              --json number,title,labels \
              --jq '[.[] | select(.labels | map(.name) | contains(["claude-code-requested"]) | not)] | first | .number // empty')
          fi

          # ãªã‘ã‚Œã° low priority ã‚’æ¢ã™
          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(gh issue list \
              --repo ${{ github.repository }} \
              --label priority:low \
              --state open \
              --json number,title,labels \
              --jq '[.[] | select(.labels | map(.name) | contains(["claude-code-requested"]) | not)] | first | .number // empty')
          fi

          # ãªã‘ã‚Œã°å„ªå…ˆåº¦ãƒ©ãƒ™ãƒ«ãªã—ã®issueã‚’æ¢ã™
          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(gh issue list \
              --repo ${{ github.repository }} \
              --state open \
              --json number,title,labels \
              --jq '[.[] | select(.labels | map(.name) | contains(["claude-code-requested"]) | not)] | first | .number // empty')
          fi

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "has_issue=false" >> $GITHUB_OUTPUT
            echo "å¯¾è±¡ã®issueãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          else
            ISSUE_TITLE=$(gh issue view $ISSUE_NUMBER \
              --repo ${{ github.repository }} \
              --json title \
              --jq '.title')
            echo "has_issue=true" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
            echo "å¯¾è±¡issue: #$ISSUE_NUMBER - $ISSUE_TITLE"
          fi

      - name: Comment on issue with @claude mention
        if: steps.get_issue.outputs.has_issue == 'true'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          gh issue comment ${{ steps.get_issue.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --body "@claude ã“ã®issueã«å–ã‚Šçµ„ã‚“ã§ãã ã•ã„ã€‚ä½œæ¥­å®Œäº†å¾Œã¯å¿…ãšPRã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚PRã®CIãŒå¤±æ•—ã—ãŸå ´åˆã¯ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"

      - name: Add claude-code-requested label
        if: steps.get_issue.outputs.has_issue == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue edit ${{ steps.get_issue.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --add-label "claude-code-requested"

      - name: Summary
        run: |
          if [ "${{ steps.get_issue.outputs.has_issue }}" = "true" ]; then
            echo "âœ… Issue #${{ steps.get_issue.outputs.issue_number }} ã« @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ"
            echo "ğŸ“ ã‚¿ã‚¤ãƒˆãƒ«: ${{ steps.get_issue.outputs.issue_title }}"
          else
            echo "â„¹ï¸ å‡¦ç†å¯¾è±¡ã®issueãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "   - claude-code-requestedãƒ©ãƒ™ãƒ«ãŒã¤ã„ã¦ã„ãªã„openãªissueãŒã‚ã‚Šã¾ã›ã‚“"
          fi
